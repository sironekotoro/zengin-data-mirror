# .github/workflows/conditional-sync.yml
name: Conditional Sync Zengin Data

on:
  schedule:
    - cron:  '0 1 * * *'   # æ¯æ—¥ 1:00 ã«å®Ÿè¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. ãƒŸãƒ©ãƒ¼ãƒ¬ãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout mirror repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      # 2. ãƒªãƒ¢ãƒ¼ãƒˆã® updated_at ã ã‘ã‚’å–å¾—
      - name: Fetch remote updated_at
        run: |
          curl -sSL \
            https://raw.githubusercontent.com/zengin-code/source-data/master/data/updated_at \
            -o remote_updated_at

      # 3. ãƒ­ãƒ¼ã‚«ãƒ«ã® updated_at ã‚’èª­ã¿è¾¼ã¿ï¼ˆæœªä½œæˆæ™‚ã¯åˆå›æ‰±ã„ï¼‰
      - name: Read local updated_at
        run: |
          if [ -f data/updated_at ]; then
            cp data/updated_at local_updated_at
          else
            echo "1970-01-01T00:00:00Z" > local_updated_at
          fi

      # 4. æ¯”è¼ƒã—ã¦åŒæœŸè¦å¦ã‚’åˆ¤å®š
      - name: Decide whether to sync
        id: decide
        run: |
          if cmp -s remote_updated_at local_updated_at; then
            echo "should_sync=false" >> $GITHUB_OUTPUT
          else
            echo "should_sync=true"  >> $GITHUB_OUTPUT
          fi

      # 5. å·®åˆ†ãŒã‚ã‚Œã°åŒæœŸå‡¦ç†
      - name: Sync data
        if: steps.decide.outputs.should_sync == 'true'
        run: |
          echo "ğŸŸ¢ Detected update ( $(
            cat remote_updated_at
          ) ), syncing full data..."
          # ã‚½ãƒ¼ã‚¹ã‚’æµ…ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ data é…ä¸‹ã‚’ä¸Šæ›¸ã
          git clone --depth 1 \
            https://github.com/zengin-code/source-data.git tmp-src
          rm -rf data
          mv tmp-src/data ./data
          rm -rf tmp-src
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data
          git commit -m "sync: updated to $(cat data/updated_at)"
          git push

      # 6. å·®åˆ†ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
      - name: Skip sync
        if: steps.decide.outputs.should_sync == 'false'
        run: echo "ğŸŸ¡ No update since $(cat local_updated_at). Skipping."
